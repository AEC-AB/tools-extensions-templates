name: Build And Publish

on:
  push:
    branches:
      - main
      - develop
      - release/*
      - hotfix/*
    tags:
      - v*
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      publish_packages:
        description: Publish built packages to nuget.org
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  id-token: write

env:
  BUILD_CONFIGURATION: Release
  NUGET_SOURCE: https://api.nuget.org/v3/index.json

jobs:
  build_packages:
    name: Build And Pack
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Setup GitVersion
        uses: gittools/actions/gitversion/setup@v3
        with:
          versionSpec: 6.x

      - name: Execute GitVersion
        id: gitversion
        uses: gittools/actions/gitversion/execute@v3

      - name: Build and pack package
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          function Invoke-Dotnet {
            param(
              [Parameter(ValueFromRemainingArguments = $true)]
              [string[]]$Arguments
            )

            & dotnet @Arguments
            if ($LASTEXITCODE -ne 0) {
              throw "dotnet $($Arguments -join ' ') failed with exit code $LASTEXITCODE."
            }
          }

          Invoke-Dotnet restore Assistant.Extensions.Templates.csproj
          Invoke-Dotnet build Assistant.Extensions.Templates.csproj --configuration $env:BUILD_CONFIGURATION --no-restore

          Invoke-Dotnet pack Assistant.Extensions.Templates.csproj --no-build --configuration $env:BUILD_CONFIGURATION --output artifacts/packages /p:PackageVersion=${{ steps.gitversion.outputs.semVer }} /p:Version=${{ steps.gitversion.outputs.semVer }}

          $revitVersions = @("2019", "2020", "2021", "2022", "2023", "2024", "2025", "2026")

          foreach ($revitVersion in $revitVersions) {
            $revitConfiguration = "Release $revitVersion"

            Invoke-Dotnet restore frameworks/RevitAppFramework/RevitAppFramework.csproj --configfile nuget.config /p:Configuration="$revitConfiguration"
            Invoke-Dotnet build frameworks/RevitAppFramework/RevitAppFramework.csproj --configuration "$revitConfiguration" --no-restore

            Invoke-Dotnet pack frameworks/RevitAppFramework/RevitAppFramework.csproj --no-build --configuration "$revitConfiguration" --output artifacts/packages /p:PackageVersion=${{ steps.gitversion.outputs.semVer }} /p:Version=${{ steps.gitversion.outputs.semVer }}
          }

          Invoke-Dotnet restore analyzers/RevitSeparationAnalyzer/RevitSeparationAnalyzer/RevitSeparationAnalyzer.csproj
          Get-ChildItem analyzers/RevitSeparationAnalyzer/RevitSeparationAnalyzer.Test -Filter *.csproj | ForEach-Object {
            Invoke-Dotnet restore $_.FullName
          }

          Invoke-Dotnet build analyzers/RevitSeparationAnalyzer/RevitSeparationAnalyzer/RevitSeparationAnalyzer.csproj --configuration $env:BUILD_CONFIGURATION --no-restore
          Get-ChildItem analyzers/RevitSeparationAnalyzer/RevitSeparationAnalyzer.Test -Filter *.csproj | ForEach-Object {
            Invoke-Dotnet build $_.FullName --configuration $env:BUILD_CONFIGURATION --no-restore
          }

          Get-ChildItem analyzers/RevitSeparationAnalyzer/RevitSeparationAnalyzer.Test -Filter *.csproj | ForEach-Object {
            Invoke-Dotnet test $_.FullName --configuration $env:BUILD_CONFIGURATION --no-build
          }

          Invoke-Dotnet pack analyzers/RevitSeparationAnalyzer/RevitSeparationAnalyzer/RevitSeparationAnalyzer.csproj --no-build --configuration $env:BUILD_CONFIGURATION --output artifacts/packages /p:PackageVersion=${{ steps.gitversion.outputs.semVer }} /p:Version=${{ steps.gitversion.outputs.semVer }}

      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages
          path: artifacts/packages/*.nupkg
          if-no-files-found: error

  publish_packages:
    name: Publish Packages
    needs: build_packages
    runs-on: windows-2022
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.publish_packages }}

    steps:
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: NuGet login
        uses: NuGet/login@v1
        id: login
        with:
          user: ${{ secrets.NUGET_USER }}

      - name: Download package artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: 'packages'
          path: artifacts/packages
          merge-multiple: true

      - name: Publish packages to nuget.org
        shell: pwsh
        run: |
          Get-ChildItem artifacts/packages -Recurse -Filter *.nupkg | ForEach-Object {
            dotnet nuget push $_.FullName --source $env:NUGET_SOURCE --api-key "${{ steps.login.outputs.NUGET_API_KEY }}" --skip-duplicate
          }